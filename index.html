<!DOCTYPE html>
<html>
<head>
    <title>My World</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { margin: 0; background: #222; overflow: hidden; font-family: sans-serif; }
        
        canvas { display: block; background: #fff; }

        #controls {
            position: fixed; bottom: 20px; right: 20px;
            display: flex; flex-direction: column; align-items: center; gap: 10px;
            z-index: 99;
            /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏ú‡∏á */
            user-select: none;
            -webkit-user-select: none;
        }
        .row { display: flex; gap: 10px; }
        
        button {
            width: 70px; height: 70px; font-size: 30px; /* ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡∏ô‡∏¥‡∏î‡∏ô‡∏∂‡∏á */
            background: rgba(255,255,255,0.3); 
            border: 2px solid white; 
            border-radius: 50%;
            color: white; 
            cursor: pointer;
            
            /* üõë ‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏≠‡∏á Browser ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î */
            user-select: none;         /* ‡∏´‡πâ‡∏≤‡∏°‡∏Ñ‡∏•‡∏∏‡∏°‡∏î‡∏≥ */
            -webkit-user-select: none; /* ‡∏´‡πâ‡∏≤‡∏°‡∏Ñ‡∏•‡∏∏‡∏°‡∏î‡∏≥ (Safari/Chrome) */
            touch-action: none;        /* ‡∏´‡πâ‡∏≤‡∏° Browser ‡πÄ‡∏≠‡∏≤‡∏ô‡∏¥‡πâ‡∏ß‡πÑ‡∏õ‡∏ã‡∏π‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏à‡∏≠ */
            -webkit-touch-callout: none; /* ‡∏´‡πâ‡∏≤‡∏°‡∏Å‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏°‡∏ô‡∏π‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Ç‡∏ß‡∏≤ (iOS) */
        }

        /* ‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° ‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∏‡∏ö‡∏•‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ */
        button:active, button.active { 
            background: rgba(255,255,255,0.8); 
            color: black; 
            transform: scale(0.9);
        }
    </style>
</head>
<body>

    <canvas id="gameCanvas"></canvas>

    <div id="controls" oncontextmenu="return false;">
        <button id="up" data-dir="up">‚¨ÜÔ∏è</button>
        <div class="row">
            <button id="left" data-dir="left">‚¨ÖÔ∏è</button>
            <button id="down" data-dir="down">‚¨áÔ∏è</button>
            <button id="right" data-dir="right">‚û°Ô∏è</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏à‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏°
        const resize = () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            draw();
        };
        window.addEventListener('resize', resize);
        resize(); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ

        let players = {};
        let myId = null;
        
        // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏ä‡πá‡∏Å‡∏ß‡πà‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏î‡∏ó‡∏¥‡∏®‡πÑ‡∏´‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ
        let movement = { up: false, down: false, left: false, right: false };

        socket.on('connect', () => myId = socket.id);
        socket.on('currentPlayers', (data) => { players = data; draw(); });
        socket.on('newPlayer', (data) => { players[data.id] = data.player; draw(); });
        socket.on('playerMoved', (data) => {
            if(players[data.id]) {
                players[data.id].x = data.x;
                players[data.id].y = data.y;
                draw();
            }
        });
        socket.on('disconnectPlayer', (id) => { delete players[id]; draw(); });

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            for (let id in players) {
                let p = players[id];
                ctx.fillStyle = p.color;
                ctx.fillRect(p.x, p.y, 30, 30);
                
                ctx.fillStyle = "black";
                ctx.font = "12px Arial";
                ctx.textAlign = "center";
                ctx.fillText(id === myId ? "ME" : "Guest", p.x + 15, p.y - 5);
            }
        }

        // --- üéÆ Game Loop (‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏Ñ‡πâ‡∏≤‡∏á) ---
        // ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ß‡∏ô‡∏ã‡πâ‡∏≥ 60 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ï‡πà‡∏≠‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏Å‡∏ß‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏´‡∏ô‡∏ñ‡∏π‡∏Å‡∏Å‡∏î‡∏≠‡∏¢‡∏π‡πà
        setInterval(() => {
            if (!myId || !players[myId]) return;

            let moveSpeed = 5;
            let moved = false;
            let x = players[myId].x;
            let y = players[myId].y;

            if (movement.up) { y -= moveSpeed; moved = true; }
            if (movement.down) { y += moveSpeed; moved = true; }
            if (movement.left) { x -= moveSpeed; moved = true; }
            if (movement.right) { x += moveSpeed; moved = true; }

            if (moved) {
                players[myId].x = x;
                players[myId].y = y;
                socket.emit('playerMovement', { x, y });
                draw();
            }
        }, 1000 / 60);

        // --- ‚å®Ô∏è ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏µ‡∏¢‡πå‡∏ö‡∏≠‡∏£‡πå‡∏î ---
        document.addEventListener('keydown', (e) => {
            if (e.repeat) return; // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Event ‡∏£‡∏±‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ
            if (e.key === 'ArrowUp' || e.key === 'w') movement.up = true;
            if (e.key === 'ArrowDown' || e.key === 's') movement.down = true;
            if (e.key === 'ArrowLeft' || e.key === 'a') movement.left = true;
            if (e.key === 'ArrowRight' || e.key === 'd') movement.right = true;
        });

        document.addEventListener('keyup', (e) => {
            if (e.key === 'ArrowUp' || e.key === 'w') movement.up = false;
            if (e.key === 'ArrowDown' || e.key === 's') movement.down = false;
            if (e.key === 'ArrowLeft' || e.key === 'a') movement.left = false;
            if (e.key === 'ArrowRight' || e.key === 'd') movement.right = false;
        });

        // --- üì± ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î (‡πÅ‡∏Å‡πâ‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ä‡πâ Pointer Events) ---
        const buttons = document.querySelectorAll('#controls button');
        
        buttons.forEach(btn => {
            const dir = btn.getAttribute('data-dir');

            // ‡πÉ‡∏ä‡πâ pointerdown ‡πÅ‡∏ó‡∏ô mousedown/touchstart (‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡∏´‡∏°‡∏î)
            btn.addEventListener('pointerdown', (e) => {
                e.preventDefault(); // ‡∏´‡πâ‡∏≤‡∏° Browser ‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏¢‡∏∏‡πà‡∏á
                movement[dir] = true;
                btn.classList.add('active');
            });

            // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö "‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏°‡∏∑‡∏≠"
            const stopMove = (e) => {
                e.preventDefault();
                movement[dir] = false;
                btn.classList.remove('active');
            };

            // ‡∏î‡∏±‡∏Å‡∏à‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà "‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏°‡∏∑‡∏≠"
            btn.addEventListener('pointerup', stopMove);       // ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÄ‡∏°‡∏≤‡∏™‡πå/‡∏ô‡∏¥‡πâ‡∏ß
            btn.addEventListener('pointerleave', stopMove);    // ‡∏•‡∏≤‡∏Å‡∏ô‡∏¥‡πâ‡∏ß‡∏≠‡∏≠‡∏Å‡∏ô‡∏≠‡∏Å‡∏õ‡∏∏‡πà‡∏°
            btn.addEventListener('pointercancel', stopMove);   // ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á/‡∏ô‡∏¥‡πâ‡∏ß‡∏´‡∏•‡∏∏‡∏î
        });

    </script>
</body>
</html>