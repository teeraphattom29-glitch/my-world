<script>
        const socket = io();
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // ✅ แก้ไข: ประกาศตัวแปร players ไว้บนสุด ก่อนที่จะถูกเรียกใช้
        let players = {};
        let myId = null;
        let movement = { up: false, down: false, left: false, right: false };

        // ฟังก์ชันวาดรูป
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            for (let id in players) {
                let p = players[id];
                ctx.fillStyle = p.color;
                ctx.fillRect(p.x, p.y, 30, 30);
                
                ctx.fillStyle = "black"; 
                ctx.font = "12px Arial"; 
                ctx.textAlign = "center";
                ctx.fillText(id === myId ? "ME" : "Guest", p.x + 15, p.y - 5);
            }
        }

        // ฟังก์ชันปรับขนาดจอ
        const resize = () => { 
            canvas.width = window.innerWidth; 
            canvas.height = window.innerHeight; 
            draw(); 
        };
        window.addEventListener('resize', resize);
        resize(); // เรียกใช้ตอนนี้ปลอดภัยแล้ว เพราะ players ถูกสร้างบรรทัดบนสุดแล้ว

        // --- ส่วนรับข้อมูลจาก Server ---
        socket.on('connect', () => myId = socket.id);
        socket.on('currentPlayers', (data) => { players = data; draw(); });
        socket.on('newPlayer', (data) => { players[data.id] = data.player; draw(); });
        socket.on('playerMoved', (data) => {
            if(players[data.id]) { players[data.id].x = data.x; players[data.id].y = data.y; draw(); }
        });
        socket.on('disconnectPlayer', (id) => { delete players[id]; draw(); });

        // --- Game Loop (เดิน) ---
        setInterval(() => {
            if (!myId || !players[myId]) return;
            let moved = false;
            if (movement.up) { players[myId].y -= 5; moved = true; }
            if (movement.down) { players[myId].y += 5; moved = true; }
            if (movement.left) { players[myId].x -= 5; moved = true; }
            if (movement.right) { players[myId].x += 5; moved = true; }
            
            if (moved) { 
                socket.emit('playerMovement', { x: players[myId].x, y: players[myId].y }); 
                draw(); 
            }
        }, 1000 / 60);

        // --- Controls ---
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowUp') movement.up = true;
            if (e.key === 'ArrowDown') movement.down = true;
            if (e.key === 'ArrowLeft') movement.left = true;
            if (e.key === 'ArrowRight') movement.right = true;
        });
        document.addEventListener('keyup', (e) => {
            if (e.key === 'ArrowUp') movement.up = false;
            if (e.key === 'ArrowDown') movement.down = false;
            if (e.key === 'ArrowLeft') movement.left = false;
            if (e.key === 'ArrowRight') movement.right = false;
        });

        document.querySelectorAll('#controls button').forEach(btn => {
            const dir = btn.getAttribute('data-dir');
            const start = (e) => { e.preventDefault(); movement[dir] = true; btn.classList.add('active'); };
            const stop = (e) => { e.preventDefault(); movement[dir] = false; btn.classList.remove('active'); };
            
            btn.addEventListener('pointerdown', start);
            btn.addEventListener('pointerup', stop);
            btn.addEventListener('pointerleave', stop);
        });
    </script>